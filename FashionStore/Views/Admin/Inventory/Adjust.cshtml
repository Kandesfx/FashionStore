@{
    ViewBag.Title = "Điều chỉnh tồn kho";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-card">
    <div class="card-header">
        <h5 class="card-title">
            <i class="fas fa-adjust me-2"></i>Điều chỉnh tồn kho
        </h5>
        <a href="@Url.Action("Index", "AdminInventory")" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Quay lại
        </a>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @using (Html.BeginForm("Adjust", "AdminInventory", FormMethod.Post))
    {
        @Html.AntiForgeryToken()

        <div class="row">
            <div class="col-md-8">
                <div class="mb-3">
                    <label class="form-label">Sản phẩm <span class="text-danger">*</span></label>
                    @Html.DropDownList("productId", new SelectList(ViewBag.Products ?? new List<dynamic>(), "Id", "ProductName"), 
                        "Chọn sản phẩm", new { @class = "form-select", required = "required", id = "productSelect" })
                </div>

                <div class="mb-3">
                    <label class="form-label">Tồn kho hiện tại</label>
                    <input type="text" id="currentStock" class="form-control" readonly />
                    <small class="text-muted">Số lượng tồn kho sẽ được cập nhật sau khi chọn sản phẩm</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Số lượng điều chỉnh <span class="text-danger">*</span></label>
                    <input type="number" name="quantity" class="form-control" required />
                    <small class="text-muted">
                        <strong>Dương (+):</strong> Tăng tồn kho<br />
                        <strong>Âm (-):</strong> Giảm tồn kho
                    </small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Lý do điều chỉnh <span class="text-danger">*</span></label>
                    <textarea name="reason" class="form-control" rows="3" required placeholder="Nhập lý do điều chỉnh tồn kho"></textarea>
                    <small class="text-muted">Ví dụ: Kiểm kê, Hàng hỏng, Sai sót, v.v.</small>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Điều chỉnh tồn kho dùng để sửa chữa các sai sót trong quản lý kho, kiểm kê, hoặc các trường hợp đặc biệt.
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Xác nhận điều chỉnh
                    </button>
                    <a href="@Url.Action("Index", "AdminInventory")" class="btn btn-secondary">
                        Hủy
                    </a>
                </div>
            </div>
        </div>
    }
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const productSelect = document.getElementById('productSelect');
        const currentStock = document.getElementById('currentStock');

        if (productSelect && currentStock) {
            productSelect.addEventListener('change', function() {
                const productId = this.value;
                if (productId) {
                    currentStock.value = 'Đang tải...';
                    
                    $.ajax({
                        url: '@Url.Action("GetProductStock", "AdminInventory")',
                        type: 'GET',
                        data: { productId: productId },
                        success: function(response) {
                            if (response && response.success && response.stock !== undefined) {
                                currentStock.value = response.stock + ' sản phẩm';
                            } else {
                                currentStock.value = 'Không xác định';
                            }
                        },
                        error: function() {
                            currentStock.value = 'Lỗi khi tải dữ liệu';
                        }
                    });
                } else {
                    currentStock.value = '';
                }
            });
        }
    });
</script>

