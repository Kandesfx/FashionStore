@model FashionStore.Models.ViewModels.CheckoutViewModel
@{
    ViewBag.Title = "Thanh toán";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .checkout-section {
        padding: 60px 0;
        background: #f8f9fa;
    }

    .breadcrumb-custom {
        background: transparent;
        padding: 0;
        margin-bottom: 30px;
        font-size: 14px;
    }

    .breadcrumb-custom a {
        color: #666;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .breadcrumb-custom a:hover {
        color: #c9a063;
    }

    .breadcrumb-custom .active {
        color: #1a1a1a;
    }

    /* Page Header */
    .page-header {
        background: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .page-title {
        font-family: 'Playfair Display', serif;
        font-size: 36px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 10px;
    }

    .page-subtitle {
        color: #666;
        font-size: 16px;
        margin: 0;
    }

    /* Progress Steps */
    .checkout-steps {
        background: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .steps-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }

    .steps-container::before {
        content: '';
        position: absolute;
        top: 25px;
        left: 50px;
        right: 50px;
        height: 3px;
        background: #e5e5e5;
        z-index: 0;
    }

    .step-item {
        text-align: center;
        position: relative;
        z-index: 1;
        flex: 1;
    }

    .step-number {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: white;
        border: 3px solid #e5e5e5;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-weight: 700;
        color: #999;
        transition: all 0.3s ease;
    }

    .step-item.active .step-number {
        background: linear-gradient(135deg, #c9a063, #d4b072);
        border-color: #c9a063;
        color: white;
        box-shadow: 0 5px 20px rgba(201, 160, 99, 0.4);
    }

    .step-item.completed .step-number {
        background: #2ecc71;
        border-color: #2ecc71;
        color: white;
    }

    .step-label {
        font-size: 14px;
        font-weight: 600;
        color: #999;
    }

    .step-item.active .step-label {
        color: #c9a063;
    }

    .step-item.completed .step-label {
        color: #2ecc71;
    }

    /* Form Container */
    .form-container {
        background: white;
        border-radius: 15px;
        padding: 35px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .form-section-title {
        font-family: 'Playfair Display', serif;
        font-size: 24px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .form-section-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #c9a063, #d4b072);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-label {
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 10px;
        font-size: 15px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .required-mark {
        color: #e74c3c;
    }

    .form-control {
        border: 2px solid #e5e5e5;
        border-radius: 10px;
        padding: 12px 20px;
        font-size: 15px;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: #c9a063;
        box-shadow: 0 0 0 0.2rem rgba(201, 160, 99, 0.15);
        outline: none;
    }

    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }

    .text-danger {
        color: #e74c3c;
        font-size: 13px;
        margin-top: 5px;
        display: block;
    }

    /* Payment Methods */
    .payment-methods {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 25px;
    }

    .payment-option {
        position: relative;
    }

    .payment-option input[type="radio"] {
        position: absolute;
        opacity: 0;
    }

    .payment-label {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 20px;
        border: 2px solid #e5e5e5;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }

    .payment-option input[type="radio"]:checked + .payment-label {
        border-color: #c9a063;
        background: linear-gradient(135deg, rgba(201, 160, 99, 0.1), rgba(212, 176, 114, 0.1));
    }

    .payment-label:hover {
        border-color: #c9a063;
    }

    .payment-icon {
        width: 50px;
        height: 50px;
        background: #f8f9fa;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #666;
    }

    .payment-option input[type="radio"]:checked + .payment-label .payment-icon {
        background: #c9a063;
        color: white;
    }

    .payment-info h5 {
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 3px;
        font-size: 16px;
    }

    .payment-info p {
        color: #666;
        font-size: 13px;
        margin: 0;
    }

    /* Bank Selection */
    .bank-selection {
        animation: fadeIn 0.3s ease;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .bank-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    .bank-btn {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 20px;
        border: 2px solid #e5e5e5;
        border-radius: 10px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
        width: 100%;
    }

    .bank-btn:hover {
        border-color: #c9a063;
        background: linear-gradient(135deg, rgba(201, 160, 99, 0.1), rgba(212, 176, 114, 0.1));
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(201, 160, 99, 0.2);
    }

    .bank-btn.active {
        border-color: #c9a063;
        background: linear-gradient(135deg, rgba(201, 160, 99, 0.15), rgba(212, 176, 114, 0.15));
        box-shadow: 0 5px 20px rgba(201, 160, 99, 0.3);
    }

    .bank-icon {
        width: 50px;
        height: 50px;
        background: #f8f9fa;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #666;
        transition: all 0.3s ease;
    }

    .bank-btn:hover .bank-icon,
    .bank-btn.active .bank-icon {
        background: #c9a063;
        color: white;
    }

    .bank-info h5 {
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 3px;
        font-size: 16px;
    }

    .bank-info p {
        color: #666;
        font-size: 13px;
        margin: 0;
    }

    /* Order Summary */
    .order-summary {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        position: sticky;
        top: 100px;
    }

    .summary-title {
        font-family: 'Playfair Display', serif;
        font-size: 24px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .order-item {
        display: flex;
        gap: 15px;
        padding: 15px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .order-item:last-child {
        border-bottom: none;
    }

    .item-image-small {
        width: 70px;
        height: 70px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
        background: #f0f0f0;
    }

    .item-image-small img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .item-info-small {
        flex: 1;
    }

    .item-name-small {
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 5px;
        font-size: 14px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .item-quantity-small {
        color: #666;
        font-size: 13px;
    }

    .item-price-small {
        font-weight: 700;
        color: #c9a063;
        white-space: nowrap;
    }

    .summary-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, #e5e5e5, transparent);
        margin: 20px 0;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 15px;
    }

    .summary-label {
        color: #666;
    }

    .summary-value {
        font-weight: 600;
        color: #1a1a1a;
    }

    .summary-total {
        display: flex;
        justify-content: space-between;
        padding-top: 20px;
        border-top: 2px solid #f0f0f0;
        margin-top: 20px;
    }

    .total-label {
        font-family: 'Playfair Display', serif;
        font-size: 18px;
        font-weight: 700;
        color: #1a1a1a;
    }

    .total-value {
        font-family: 'Playfair Display', serif;
        font-size: 24px;
        font-weight: 700;
        color: #c9a063;
    }

    /* Buttons */
    .btn-place-order {
        background: linear-gradient(135deg, #c9a063, #d4b072);
        color: white;
        padding: 16px 40px;
        border: none;
        border-radius: 50px;
        font-size: 16px;
        font-weight: 600;
        width: 100%;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 20px rgba(201, 160, 99, 0.4);
        margin-top: 25px;
    }

    .btn-place-order:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(201, 160, 99, 0.6);
    }

    .btn-back {
        background: white;
        color: #1a1a1a;
        padding: 12px 30px;
        border: 2px solid #e5e5e5;
        border-radius: 50px;
        font-size: 15px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .btn-back:hover {
        border-color: #c9a063;
        color: #c9a063;
    }

    /* Security Notice */
    .security-notice {
        background: #e8f5e9;
        padding: 15px 20px;
        border-radius: 10px;
        margin-top: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        border-left: 4px solid #2ecc71;
    }

    .security-icon {
        font-size: 24px;
        color: #2ecc71;
    }

    .security-text {
        flex: 1;
    }

    .security-text h6 {
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 3px;
        font-size: 14px;
    }

    .security-text p {
        color: #666;
        font-size: 12px;
        margin: 0;
    }

    /* Responsive */
    @@media (max-width: 991px) {
        .order-summary {
            position: static;
            margin-top: 30px;
        }

        .steps-container {
            flex-wrap: wrap;
        }

        .steps-container::before {
            display: none;
        }

        .step-item {
            width: 33.33%;
            margin-bottom: 20px;
        }
    }

    @@media (max-width: 767px) {
        .page-title {
            font-size: 28px;
        }

        .form-container {
            padding: 25px 20px;
        }

        .payment-methods {
            grid-template-columns: 1fr;
        }

        .bank-buttons {
            grid-template-columns: 1fr;
        }

        .step-item {
            width: 100%;
        }
    }

/* MoMo Modal */
.momo-modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.55);
    display: none;
    z-index: 1050;
}

.momo-modal-backdrop.is-open {
    display: flex;
    align-items: center;
    justify-content: center;
}

.momo-modal {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 12px 44px rgba(0,0,0,0.16);
    max-width: 520px;
    width: 90%;
    padding: 24px;
    position: relative;
    text-align: center;
}

.momo-modal .close-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    border: none;
    background: transparent;
    font-size: 20px;
    cursor: pointer;
    color: #666;
}

.momo-modal .momo-amount {
    font-size: 22px;
    font-weight: 700;
    color: #a50064;
    margin: 6px 0 14px;
}

.momo-modal .qr-box {
    display: inline-block;
    padding: 14px;
    border: 1px dashed #e0e0e0;
    border-radius: 12px;
    background: #fafafa;
}

.momo-modal .qr-box img {
    width: 240px;
    height: 240px;
}

.momo-modal .momo-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 14px;
}

.momo-modal .btn-momo {
    background: linear-gradient(135deg, #a50064, #d81b60);
    color: #fff;
    border: none;
    padding: 10px 16px;
    border-radius: 10px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
}

.momo-modal .btn-momo:hover {
    opacity: 0.92;
    color: #fff;
}

/* Payment Success Modal Styles */
.payment-result-modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1060;
    animation: fadeIn 0.3s ease;
}

.payment-result-modal {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
    max-width: 500px;
    width: 90%;
    padding: 0;
    position: relative;
    text-align: center;
    animation: slideUp 0.4s ease;
}

.payment-result-header {
    padding: 30px 30px 20px;
    border-bottom: 1px solid #f0f0f0;
}

.payment-result-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    font-size: 40px;
    color: white;
}

.payment-result-icon.success {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    box-shadow: 0 8px 24px rgba(46, 204, 113, 0.4);
}

.payment-result-icon.failed {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    box-shadow: 0 8px 24px rgba(231, 76, 60, 0.4);
}

.payment-result-title {
    font-size: 24px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 10px;
}

.payment-result-subtitle {
    color: #666;
    font-size: 14px;
}

.payment-result-body {
    padding: 25px 30px;
}

.payment-result-info {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.payment-result-info-label {
    color: #666;
    font-size: 13px;
    margin-bottom: 5px;
}

.payment-result-info-value {
    color: #1a1a1a;
    font-size: 18px;
    font-weight: 600;
}

.payment-result-message {
    color: #666;
    font-size: 14px;
    line-height: 1.6;
    margin-bottom: 25px;
}

.payment-result-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
}

.btn-result {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    font-size: 15px;
}

.btn-result-primary {
    background: linear-gradient(135deg, #c9a063, #d4b072);
    color: white;
    box-shadow: 0 4px 12px rgba(201, 160, 99, 0.3);
}

.btn-result-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(201, 160, 99, 0.4);
    color: white;
}

.btn-result-secondary {
    background: white;
    color: #666;
    border: 2px solid #e5e5e5;
}

.btn-result-secondary:hover {
    border-color: #c9a063;
    color: #c9a063;
}

.auto-redirect-countdown {
    color: #999;
    font-size: 12px;
    margin-top: 15px;
}
</style>

<section class="checkout-section">
    <div class="container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb-custom">
            <a href="@Url.Action("Index", "Home")">Trang chủ</a>
            <span class="mx-2">/</span>
            <a href="@Url.Action("Index", "Cart")">Giỏ hàng</a>
            <span class="mx-2">/</span>
            <span class="active">Thanh toán</span>
        </nav>

        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Thanh Toán Đơn Hàng</h1>
            <p class="page-subtitle">Vui lòng điền đầy đủ thông tin để hoàn tất đơn hàng</p>
        </div>

        <!-- Progress Steps -->
        <div class="checkout-steps">
            <div class="steps-container">
                <div class="step-item completed">
                    <div class="step-number">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="step-label">Giỏ hàng</div>
                </div>
                <div class="step-item active">
                    <div class="step-number">2</div>
                    <div class="step-label">Thanh toán</div>
                </div>
                <div class="step-item">
                    <div class="step-number">3</div>
                    <div class="step-label">Hoàn tất</div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Checkout Form -->
            <div class="col-lg-7">
                <div class="form-container">
                    @using (Html.BeginForm("Checkout", "Order", FormMethod.Post))
                    {
                        @Html.AntiForgeryToken()
                        @Html.ValidationSummary(true, "", new { @class = "alert alert-danger" })
                        <!-- Shipping Information -->
                        <div class="form-section-title">
                            <div class="form-section-icon">
                                <i class="fas fa-shipping-fast"></i>
                            </div>
                            Thông Tin Giao Hàng
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(m => m.FullName, new { @class = "form-label" })
                                    <span class="required-mark">*</span>
                                    @Html.TextBoxFor(m => m.FullName, new { @class = "form-control", placeholder = "Nguyễn Văn A" })
                                    @Html.ValidationMessageFor(m => m.FullName, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(m => m.Phone, new { @class = "form-label" })
                                    <span class="required-mark">*</span>
                                    @Html.TextBoxFor(m => m.Phone, new { @class = "form-control", placeholder = "0901234567" })
                                    @Html.ValidationMessageFor(m => m.Phone, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            @Html.LabelFor(m => m.ShippingAddress, new { @class = "form-label" })
                            <span class="required-mark">*</span>
                            @Html.TextAreaFor(m => m.ShippingAddress, new { @class = "form-control", rows = 3, placeholder = "Số nhà, tên đường, phường/xã, quận/huyện, tỉnh/thành phố" })
                            @Html.ValidationMessageFor(m => m.ShippingAddress, "", new { @class = "text-danger" })
                        </div>

                        <!-- Payment Method -->
                        <div class="form-section-title" style="margin-top: 40px;">
                            <div class="form-section-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            Phương Thức Thanh Toán
                        </div>

                        <div class="payment-methods">
                            <div class="payment-option">
                                @Html.RadioButtonFor(m => m.PaymentMethod, "COD", new { id = "payment-cod" })
                                <label for="payment-cod" class="payment-label">
                                    <div class="payment-icon">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </div>
                                    <div class="payment-info">
                                        <h5>Thanh toán COD</h5>
                                        <p>Thanh toán khi nhận hàng</p>
                                    </div>
                                </label>
                            </div>
                            <div class="payment-option">
                                @Html.RadioButtonFor(m => m.PaymentMethod, "MoMo", new { id = "payment-momo" })
                                <label for="payment-momo" class="payment-label">
                                    <div class="payment-icon">
                                        <i class="fas fa-mobile-alt"></i>
                                    </div>
                                    <div class="payment-info">
                                        <h5>MoMo</h5>
                                        <p>Ví điện tử MoMo</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        @Html.ValidationMessageFor(m => m.PaymentMethod, "", new { @class = "text-danger" })

                        <!-- Notes -->
                        <div class="form-group" style="margin-top: 25px;">
                            @Html.LabelFor(m => m.Notes, new { @class = "form-label" })
                            @Html.TextAreaFor(m => m.Notes, new { @class = "form-control", rows = 3, placeholder = "Ghi chú thêm về đơn hàng (tùy chọn)..." })
                            @Html.ValidationMessageFor(m => m.Notes, "", new { @class = "text-danger" })
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <a href="@Url.Action("Index", "Cart")" class="btn-back">
                                <i class="fas fa-arrow-left"></i>
                                Quay lại giỏ hàng
                            </a>
                            <button type="submit" class="btn-place-order" style="flex: 1;">
                                <i class="fas fa-check-circle me-2"></i>
                                Đặt Hàng Ngay
                            </button>
                        </div>
                    }
                </div>
            </div>

            <!-- Order Summary -->
            <div class="col-lg-5">
                <div class="order-summary">
                    <h3 class="summary-title">Tóm Tắt Đơn Hàng</h3>

                    @if (ViewBag.Cart != null)
                    {
                        var cart = (FashionStore.Models.ViewModels.CartViewModel)ViewBag.Cart;

                        <!-- Order Items -->
                        <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                            @foreach (var item in cart.Items)
                            {
                                <div class="order-item">
                                    <div class="item-image-small">
                                        <img src="@item.ImageUrl" alt="@item.ProductName">
                                    </div>
                                    <div class="item-info-small">
                                        <div class="item-name-small">@item.ProductName</div>
                                        <div class="item-quantity-small">Số lượng: @item.Quantity</div>
                                    </div>
                                    <div class="item-price-small">@item.SubTotal.ToString("N0")đ</div>
                                </div>
                            }
                        </div>

                        <div class="summary-divider"></div>

                        <!-- Price Summary -->
                        <div class="summary-row">
                            <span class="summary-label">Tạm tính</span>
                            <span class="summary-value">@cart.TotalAmount.ToString("N0")đ</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Phí vận chuyển</span>
                            @{
                                var shipping = cart.TotalAmount >= 500000 ? 0 : 30000;
                            }
                            @if (shipping == 0)
                            {
                                <span class="summary-value" style="color: #2ecc71;">Miễn phí</span>
                            }
                            else
                            {
                                <span class="summary-value">@shipping.ToString("N0")đ</span>
                            }
                        </div>

                        <div class="summary-total">
                            <span class="total-label">Tổng cộng</span>
                            <span class="total-value">@((cart.TotalAmount + shipping).ToString("N0"))đ</span>
                        </div>

                        <!-- Security Notice -->
                        <div class="security-notice">
                            <div class="security-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="security-text">
                                <h6>Thanh toán an toàn & bảo mật</h6>
                                <p>Thông tin của bạn được mã hóa và bảo mật 100%</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</section>

@if (ViewBag.MomoPayment != null)
{
    var momo = (FashionStore.Models.ViewModels.MomoPaymentViewModel)ViewBag.MomoPayment;
    // Ưu tiên deeplink, sau đó payUrl; chỉ fallback qrCodeUrl nếu thiếu
    var qrData = !string.IsNullOrEmpty(momo.Deeplink)
        ? momo.Deeplink
        : (!string.IsNullOrEmpty(momo.PayUrl) ? momo.PayUrl : momo.QrCodeUrl);
    var qrImage = $"https://api.qrserver.com/v1/create-qr-code/?size=280x280&data={System.Web.HttpUtility.UrlEncode(qrData)}";
    <div id="momo-modal-backdrop" class="momo-modal-backdrop" data-show="@((ViewBag.ShowMomoModal == true).ToString().ToLower())" data-order-id="@momo.OrderId">
        <div class="momo-modal">
            <button type="button" id="momo-modal-close" class="close-btn">&times;</button>
            <div class="momo-header" style="display:flex;align-items:center;justify-content:center;gap:10px;">
                <i class="fas fa-mobile-alt" style="color:#a50064;font-size:24px;"></i>
                <h4 style="margin:0;">Thanh toán MoMo</h4>
            </div>
            <div class="text-muted" style="margin-top:4px;">Đơn hàng #@momo.OrderId</div>
            <div class="momo-amount">@momo.Amount.ToString("N0")đ</div>
            <div class="qr-box">
                <img src="@qrImage" alt="QR MoMo" />
            </div>
            <div class="text-muted" style="margin-top:8px;">Mở ứng dụng MoMo, chọn Quét mã để thanh toán</div>
            <div class="momo-actions">
                <a class="btn-momo" href="@momo.PayUrl" target="_blank" rel="noopener">
                    <i class="fas fa-external-link-alt me-1"></i> Mở liên kết MoMo
                </a>
                <button type="button" class="btn btn-outline-secondary" id="momo-modal-close-2">
                    <i class="fas fa-times me-1"></i> Đóng
                </button>
            </div>
        </div>
    </div>
}

@section Scripts {
    <!-- jQuery from CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        // Wait for jQuery to be loaded
        (function() {
            // Check if jQuery is loaded, if not wait and retry
            function initCheckoutScript() {
                if (typeof jQuery === 'undefined') {
                    setTimeout(initCheckoutScript, 50);
                    return;
                }
                
                // Auto-select first payment method if none selected
                jQuery(document).ready(function($) {
            if (!$('input[name="PaymentMethod"]:checked').length) {
                $('#payment-cod').prop('checked', true);
            }

            // Form validation
            $('form').submit(function(e) {
                // Don't submit if MoMo modal is open
                if ($('#momo-modal-backdrop').hasClass('is-open')) {
                    e.preventDefault();
                    return false;
                }

                var isValid = true;
                var errors = [];

                // Check required fields
                if (!$('#FullName').val().trim()) {
                    errors.push('Vui lòng nhập họ tên');
                    isValid = false;
                }

                if (!$('#Phone').val().trim()) {
                    errors.push('Vui lòng nhập số điện thoại');
                    isValid = false;
                }

                if (!$('#ShippingAddress').val().trim()) {
                    errors.push('Vui lòng nhập địa chỉ giao hàng');
                    isValid = false;
                }

                if (!$('input[name="PaymentMethod"]:checked').length) {
                    errors.push('Vui lòng chọn phương thức thanh toán');
                    isValid = false;
                }

                if (!isValid) {
                    e.preventDefault();
                    alert(errors.join('\n'));
                    return false;
                }

                // Show loading
                $('.btn-place-order').html('<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...').prop('disabled', true);
            });

            // Phone number validation
            $('#Phone').on('input', function() {
                this.value = this.value.replace(/[^0-9]/g, '');
            });

            // MoMo modal handling
            var $momoModal = $('#momo-modal-backdrop');
            var currentOrderId = null;
            var paymentCheckInterval = null;
            var paymentChannel = null;
            
            // Kiểm tra ngay khi trang load xem có kết quả thanh toán không
            function checkPaymentResultOnLoad() {
                if ($momoModal.length && $momoModal.data('order-id')) {
                    var orderId = $momoModal.data('order-id');
                    var paymentResultKey = 'momo_payment_result_' + orderId;
                    var paymentResultStr = localStorage.getItem(paymentResultKey);
                    if (paymentResultStr) {
                        try {
                            var paymentResult = JSON.parse(paymentResultStr);
                            var timeDiff = new Date().getTime() - paymentResult.timestamp;
                            if (timeDiff < 300000) { // Trong vòng 5 phút
                                console.log('Phát hiện thanh toán đã hoàn thành khi load trang:', paymentResult);
                                if (paymentResult.success && paymentResult.resultCode === "0") {
                                    // Đã thanh toán thành công
                                    $momoModal.removeClass('is-open').hide();
                                    showSuccessModal(orderId, "Paid");
                                    localStorage.removeItem(paymentResultKey);
                                    return true; // Đã xử lý, không cần start polling
                                } else if (!paymentResult.success) {
                                    // Thanh toán thất bại
                                    $momoModal.removeClass('is-open').hide();
                                    showFailedModal(orderId, "Failed");
                                    localStorage.removeItem(paymentResultKey);
                                    return true;
                                }
                            } else {
                                // Kết quả cũ, xóa đi
                                localStorage.removeItem(paymentResultKey);
                            }
                        } catch (e) {
                            console.error('Lỗi parse localStorage khi load:', e);
                        }
                    }
                }
                return false;
            }
            
            // Kiểm tra khi trang load
            if (checkPaymentResultOnLoad()) {
                // Đã xử lý, không cần start polling
            } else if ($momoModal.length && $momoModal.data('show') === true) {
                $momoModal.addClass('is-open');
                $momoModal.show();
                // Lấy orderId từ data attribute
                currentOrderId = $momoModal.data('order-id');
                console.log('Popup QR code được mở cho đơn hàng #' + currentOrderId);
                
                if (currentOrderId) {
                    // Lắng nghe BroadcastChannel
                    try {
                        if (typeof BroadcastChannel !== 'undefined') {
                            paymentChannel = new BroadcastChannel('momo_payment');
                            paymentChannel.onmessage = function(event) {
                                var data = event.data;
                                if (data.type === 'payment_result' && data.orderId == currentOrderId) {
                                    console.log('Nhận được message từ BroadcastChannel:', data);
                                    if (data.success && data.resultCode === "0") {
                                        clearInterval(paymentCheckInterval);
                                        paymentCheckInterval = null;
                                        closeMomoModal();
                                        showSuccessModal(currentOrderId, "Paid");
                                    } else if (!data.success) {
                                        clearInterval(paymentCheckInterval);
                                        paymentCheckInterval = null;
                                        closeMomoModal();
                                        showFailedModal(currentOrderId, "Failed");
                                    }
                                }
                            };
                            console.log('Đã lắng nghe BroadcastChannel');
                        }
                    } catch (e) {
                        console.error('Lỗi BroadcastChannel:', e);
                    }
                    
                    // Lắng nghe window.postMessage (fallback)
                    window.addEventListener('message', function(event) {
                        if (event.data && event.data.type === 'momo_payment_result' && event.data.orderId == currentOrderId) {
                            console.log('Nhận được message qua postMessage:', event.data);
                            if (event.data.success && event.data.resultCode === "0") {
                                clearInterval(paymentCheckInterval);
                                paymentCheckInterval = null;
                                closeMomoModal();
                                showSuccessModal(currentOrderId, "Paid");
                            }
                        }
                    });
                    
                    // Kiểm tra khi tab được focus lại
                    $(window).on('focus', function() {
                        if (currentOrderId) {
                            console.log('Tab được focus, kiểm tra lại trạng thái đơn hàng #' + currentOrderId);
                            var paymentResultKey = 'momo_payment_result_' + currentOrderId;
                            var paymentResultStr = localStorage.getItem(paymentResultKey);
                            if (paymentResultStr) {
                                try {
                                    var paymentResult = JSON.parse(paymentResultStr);
                                    var timeDiff = new Date().getTime() - paymentResult.timestamp;
                                    if (timeDiff < 300000 && paymentResult.success && paymentResult.resultCode === "0") {
                                        clearInterval(paymentCheckInterval);
                                        paymentCheckInterval = null;
                                        closeMomoModal();
                                        showSuccessModal(currentOrderId, "Paid");
                                        localStorage.removeItem(paymentResultKey);
                                    }
                                } catch (e) {
                                    console.error('Lỗi parse localStorage khi focus:', e);
                                }
                            }
                        }
                    });
                    
                    // Bắt đầu polling kiểm tra trạng thái thanh toán
                    startPaymentStatusPolling(currentOrderId);
                } else {
                    console.error('Không tìm thấy orderId trong modal');
                }
            }

            function startPaymentStatusPolling(orderId) {
                if (paymentCheckInterval) {
                    clearInterval(paymentCheckInterval);
                }
                
                var checkCount = 0;
                var maxChecks = 180; // Tối đa 3 phút (180 lần x 1 giây)
                
                console.log('Bắt đầu polling kiểm tra trạng thái đơn hàng #' + orderId);
                
                paymentCheckInterval = setInterval(function() {
                    checkCount++;
                    
                    // Kiểm tra localStorage trước (nhanh hơn)
                    var paymentResultKey = 'momo_payment_result_' + orderId;
                    var paymentResultStr = localStorage.getItem(paymentResultKey);
                    if (paymentResultStr) {
                        try {
                            var paymentResult = JSON.parse(paymentResultStr);
                            // Kiểm tra xem kết quả có mới không (trong vòng 5 phút)
                            var timeDiff = new Date().getTime() - paymentResult.timestamp;
                            if (timeDiff < 300000) { // 5 phút
                                console.log('Phát hiện kết quả thanh toán từ localStorage:', paymentResult);
                                if (paymentResult.success && paymentResult.resultCode === "0") {
                                    // Thanh toán thành công từ localStorage
                                    clearInterval(paymentCheckInterval);
                                    paymentCheckInterval = null;
                                    localStorage.removeItem(paymentResultKey); // Xóa sau khi dùng
                                    closeMomoModal();
                                    showSuccessModal(orderId, "Paid");
                                    return;
                                } else if (!paymentResult.success) {
                                    // Thanh toán thất bại từ localStorage
                                    clearInterval(paymentCheckInterval);
                                    paymentCheckInterval = null;
                                    localStorage.removeItem(paymentResultKey); // Xóa sau khi dùng
                                    closeMomoModal();
                                    showFailedModal(orderId, "Failed");
                                    return;
                                }
                            } else {
                                // Kết quả cũ, xóa đi
                                localStorage.removeItem(paymentResultKey);
                            }
                        } catch (e) {
                            console.error('Lỗi parse localStorage:', e);
                        }
                    }
                    
                    // Kiểm tra từ server
                    $.ajax({
                        url: '@Url.Action("CheckStatus", "Order")',
                        type: 'GET',
                        data: { orderId: orderId },
                        dataType: 'json',
                        cache: false,
                        success: function(response) {
                            console.log('Kiểm tra trạng thái đơn hàng #' + orderId + ':', response);
                            
                            if (response && response.success) {
                                if (response.isPaid || response.status === "Paid") {
                                    // Thanh toán thành công
                                    console.log('Phát hiện thanh toán thành công từ server!');
                                    clearInterval(paymentCheckInterval);
                                    paymentCheckInterval = null;
                                    closeMomoModal();
                                    showSuccessModal(orderId, response.status);
                                } else if (response.status === "Failed") {
                                    // Thanh toán thất bại
                                    console.log('Phát hiện thanh toán thất bại từ server!');
                                    clearInterval(paymentCheckInterval);
                                    paymentCheckInterval = null;
                                    closeMomoModal();
                                    showFailedModal(orderId, response.status);
                                }
                            }
                        },
                        error: function(xhr, status, error) {
                            console.log('Lỗi khi kiểm tra trạng thái:', error);
                            // Lỗi khi kiểm tra, tiếp tục thử
                        },
                        complete: function() {
                            // Dừng polling sau maxChecks lần
                            if (checkCount >= maxChecks) {
                                console.log('Đã đạt số lần kiểm tra tối đa, dừng polling');
                                clearInterval(paymentCheckInterval);
                                paymentCheckInterval = null;
                            }
                        }
                    });
                }, 1000); // Kiểm tra mỗi 1 giây
            }

            function showSuccessModal(orderId, status) {
                console.log('Hiển thị modal thành công cho đơn hàng #' + orderId);
                
                // Xóa modal cũ nếu có
                $('#payment-success-modal-backdrop, #payment-failed-modal-backdrop').remove();
                
                // Tạo modal thông báo thành công
                var successHtml = `
                    <div id="payment-success-modal-backdrop" class="payment-result-modal-backdrop" style="display: flex; z-index: 1070;">
                        <div class="payment-result-modal">
                            <div class="payment-result-header">
                                <div class="payment-result-icon success">
                                    <i class="fas fa-check"></i>
                                </div>
                                <h3 class="payment-result-title">Thanh toán thành công!</h3>
                                <p class="payment-result-subtitle">Đơn hàng của bạn đã được xử lý</p>
                            </div>
                            <div class="payment-result-body">
                                <div class="payment-result-info">
                                    <div class="payment-result-info-label">Mã đơn hàng</div>
                                    <div class="payment-result-info-value">#${orderId}</div>
                                </div>
                                <div class="payment-result-message">
                                    Thanh toán đã được xử lý thành công. Đơn hàng của bạn đang được chuẩn bị.
                                </div>
                                <div class="payment-result-actions">
                                    <a href="@Url.Action("MyOrders", "Order")" class="btn-result btn-result-primary">
                                        <i class="fas fa-shopping-bag"></i>
                                        Xem đơn hàng
                                    </a>
                                    <a href="@Url.Action("Index", "Home")" class="btn-result btn-result-secondary">
                                        <i class="fas fa-home"></i>
                                        Về trang chủ
                                    </a>
                                </div>
                                <div class="auto-redirect-countdown">
                                    Tự động chuyển đến trang đơn hàng sau <span id="countdown-number">5</span> giây...
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $('body').append(successHtml);
                
                // Auto redirect sau 5 giây
                var countdown = 5;
                var countdownElement = $('#countdown-number');
                var countdownInterval = setInterval(function() {
                    countdown--;
                    if (countdownElement.length) {
                        countdownElement.text(countdown);
                    }
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        window.location.href = '@Url.Action("MyOrders", "Order")';
                    }
                }, 1000);
            }

            function showFailedModal(orderId, status) {
                // Tạo modal thông báo thất bại
                var failedHtml = `
                    <div id="payment-failed-modal-backdrop" class="payment-result-modal-backdrop" style="display: flex;">
                        <div class="payment-result-modal">
                            <div class="payment-result-header">
                                <div class="payment-result-icon failed">
                                    <i class="fas fa-times"></i>
                                </div>
                                <h3 class="payment-result-title">Thanh toán thất bại</h3>
                                <p class="payment-result-subtitle">Vui lòng thử lại hoặc chọn phương thức khác</p>
                            </div>
                            <div class="payment-result-body">
                                <div class="payment-result-info">
                                    <div class="payment-result-info-label">Mã đơn hàng</div>
                                    <div class="payment-result-info-value">#${orderId}</div>
                                </div>
                                <div class="payment-result-message">
                                    Thanh toán không thành công. Vui lòng kiểm tra lại thông tin thanh toán hoặc chọn phương thức thanh toán khác.
                                </div>
                                <div class="payment-result-actions">
                                    <a href="@Url.Action("Checkout", "Order")" class="btn-result btn-result-primary">
                                        <i class="fas fa-redo"></i>
                                        Thử lại
                                    </a>
                                    <a href="@Url.Action("Index", "Cart")" class="btn-result btn-result-secondary">
                                        <i class="fas fa-shopping-cart"></i>
                                        Về giỏ hàng
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $('body').append(failedHtml);
                
                // Cho phép đóng modal khi click vào backdrop
                $('#payment-failed-modal-backdrop').on('click', function(e) {
                    if (e.target.id === 'payment-failed-modal-backdrop') {
                        $(this).remove();
                    }
                });
            }

            function closeMomoModal(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                console.log('Đóng popup QR code');
                $momoModal.removeClass('is-open');
                $momoModal.hide();
                if (paymentCheckInterval) {
                    clearInterval(paymentCheckInterval);
                    paymentCheckInterval = null;
                }
                return false;
            }

            $('#momo-modal-close, #momo-modal-close-2').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                closeMomoModal(e);
                return false;
            });

            $momoModal.on('click', function(e) {
                if (e.target.id === 'momo-modal-backdrop') {
                    e.preventDefault();
                    e.stopPropagation();
                    closeMomoModal(e);
                    return false;
                }
            });

                });
            }
            
            // Start initialization
            initCheckoutScript();
        })();
    </script>
}