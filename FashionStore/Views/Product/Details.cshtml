@model FashionStore.Models.Entities.Product
@{
    ViewBag.Title = Model.ProductName;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@functions {
    public string GetColorCode(string colorName)
    {
        if (string.IsNullOrEmpty(colorName)) return "#ccc";
        
        var colorMap = new Dictionary<string, string>
        {
            { "Đỏ", "#e74c3c" },
            { "Xanh", "#3498db" },
            { "Xanh lá", "#2ecc71" },
            { "Vàng", "#f1c40f" },
            { "Cam", "#e67e22" },
            { "Tím", "#9b59b6" },
            { "Hồng", "#e91e63" },
            { "Đen", "#1a1a1a" },
            { "Trắng", "#ffffff" },
            { "Xám", "#95a5a6" },
            { "Nâu", "#8b4513" },
            { "Be", "#f5deb3" }
        };
        
        return colorMap.ContainsKey(colorName) ? colorMap[colorName] : "#ccc";
    }
}

<style>
    .product-detail-section {
        padding: 60px 0;
        background: white;
    }

    .breadcrumb-custom {
        background: transparent;
        padding: 0;
        margin-bottom: 30px;
        font-size: 14px;
    }

    .breadcrumb-custom a {
        color: #666;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .breadcrumb-custom a:hover {
        color: #c9a063;
    }

    .breadcrumb-custom .active {
        color: #1a1a1a;
    }

    /* Image Gallery */
    .product-gallery {
        position: sticky;
        top: 100px;
    }

    .main-image-container {
        position: relative;
        overflow: hidden;
        border-radius: 15px;
        background: #f8f9fa;
        margin-bottom: 20px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .main-image {
        width: 100%;
        height: 550px;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .main-image:hover {
        transform: scale(1.05);
    }

    .discount-badge {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #e74c3c;
        color: white;
        padding: 8px 20px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 16px;
        box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
    }

    .thumbnail-gallery {
        display: flex;
        gap: 15px;
    }

    .thumbnail-item {
        flex: 1;
        height: 120px;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.3s ease;
        position: relative;
    }

    .thumbnail-item:hover {
        border-color: #c9a063;
        transform: translateY(-5px);
    }

    .thumbnail-item.active {
        border-color: #c9a063;
        box-shadow: 0 5px 15px rgba(201, 160, 99, 0.4);
    }

    .thumbnail-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Product Info */
    .product-info-container {
        padding-left: 30px;
    }

    .product-title {
        font-family: 'Playfair Display', serif;
        font-size: 36px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 15px;
        line-height: 1.3;
    }

    .product-category {
        display: inline-block;
        background: #f8f9fa;
        color: #666;
        padding: 6px 20px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 20px;
    }

    .product-rating {
        margin-bottom: 20px;
    }

    .stars {
        color: #ffc107;
        font-size: 18px;
        margin-right: 10px;
    }

    .rating-text {
        color: #666;
        font-size: 14px;
    }

    .divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, #e5e5e5, transparent);
        margin: 25px 0;
    }

    .price-container {
        margin-bottom: 30px;
    }

    .price-current {
        font-size: 42px;
        font-weight: 700;
        color: #e74c3c;
        font-family: 'Playfair Display', serif;
    }

    .price-original {
        font-size: 24px;
        color: #999;
        text-decoration: line-through;
        margin-left: 15px;
    }

    .price-regular {
        font-size: 42px;
        font-weight: 700;
        color: #1a1a1a;
        font-family: 'Playfair Display', serif;
    }

    .save-amount {
        display: inline-block;
        background: #e8f5e9;
        color: #2ecc71;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        margin-left: 15px;
    }

    .stock-info {
        background: #f8f9fa;
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 25px;
        border-left: 4px solid #2ecc71;
    }

    .stock-info i {
        color: #2ecc71;
        margin-right: 10px;
    }

    .stock-info.low-stock {
        border-left-color: #ffc107;
    }

    .stock-info.low-stock i {
        color: #ffc107;
    }

    .stock-info.out-of-stock {
        border-left-color: #e74c3c;
    }

    .stock-info.out-of-stock i {
        color: #e74c3c;
    }

    .product-description {
        color: #666;
        line-height: 1.8;
        font-size: 16px;
        margin-bottom: 30px;
    }

    /* Quantity Selector */
    .quantity-selector {
        margin-bottom: 30px;
    }

    .quantity-label {
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 10px;
        display: block;
        font-size: 16px;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .quantity-input-group {
        display: flex;
        border: 2px solid #e5e5e5;
        border-radius: 50px;
        overflow: hidden;
        background: white;
    }

    .quantity-btn {
        width: 45px;
        height: 45px;
        border: none;
        background: #f8f9fa;
        color: #1a1a1a;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .quantity-btn:hover {
        background: #c9a063;
        color: white;
    }

    .quantity-input {
        width: 80px;
        border: none;
        text-align: center;
        font-size: 18px;
        font-weight: 600;
        color: #1a1a1a;
    }

    .quantity-input:focus {
        outline: none;
    }

    /* Variant Selector */
    .variant-selector {
        margin-bottom: 25px;
    }

    .variant-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .variant-btn {
        padding: 10px 20px;
        border: 2px solid #e5e5e5;
        background: white;
        color: #1a1a1a;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 60px;
        text-align: center;
    }

    .variant-btn:hover {
        border-color: #c9a063;
        color: #c9a063;
        transform: translateY(-2px);
    }

    .variant-btn.selected {
        background: #c9a063;
        color: white;
        border-color: #c9a063;
    }

    .variant-btn.color-btn {
        position: relative;
        padding-left: 40px;
    }

    .variant-btn.color-btn::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #ddd;
    }

    .variant-btn.color-btn.selected::before {
        border-color: white;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
    }

    .btn-add-cart {
        flex: 1;
        background: #1a1a1a;
        color: white;
        padding: 16px 40px;
        border: 2px solid #1a1a1a;
        border-radius: 50px;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .btn-add-cart:hover {
        background: #c9a063;
        border-color: #c9a063;
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }

    .btn-wishlist {
        width: 55px;
        height: 55px;
        background: white;
        color: #1a1a1a;
        border: 2px solid #e5e5e5;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-wishlist:hover {
        background: #c9a063;
        color: white;
        border-color: #c9a063;
        transform: scale(1.1);
    }

    /* Product Features */
    .product-features {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 30px;
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
    }

    .feature-item:last-child {
        margin-bottom: 0;
    }

    .feature-icon {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #c9a063, #d4b072);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
    }

    .feature-text {
        flex: 1;
    }

    .feature-title {
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 3px;
        font-size: 15px;
    }

    .feature-desc {
        color: #666;
        font-size: 13px;
        margin: 0;
    }

    /* Related Products */
    .related-section {
        padding: 60px 0;
        background: #f8f9fa;
    }

    .section-title {
        font-family: 'Playfair Display', serif;
        font-size: 36px;
        font-weight: 700;
        color: #1a1a1a;
        text-align: center;
        margin-bottom: 15px;
    }

    .section-divider {
        width: 80px;
        height: 3px;
        background: linear-gradient(90deg, transparent, #c9a063, transparent);
        margin: 0 auto 50px;
    }

    .related-product-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        margin-bottom: 30px;
    }

    .related-product-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    .related-product-image {
        height: 280px;
        overflow: hidden;
        background: #f8f9fa;
        position: relative;
    }

    .related-product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .related-product-card:hover .related-product-image img {
        transform: scale(1.1);
    }

    .related-product-info {
        padding: 20px;
    }

    .related-product-name {
        font-family: 'Playfair Display', serif;
        font-size: 18px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 10px;
        min-height: 48px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .related-product-price {
        margin-bottom: 15px;
    }

    .related-price-original {
        text-decoration: line-through;
        color: #999;
        font-size: 14px;
        margin-right: 8px;
    }

    .related-price-discount {
        color: #e74c3c;
        font-size: 20px;
        font-weight: 700;
    }

    .related-price-regular {
        color: #1a1a1a;
        font-size: 20px;
        font-weight: 700;
    }

    .btn-view-detail {
        background: #1a1a1a;
        color: white;
        padding: 10px 25px;
        border-radius: 25px;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        border: 2px solid #1a1a1a;
    }

    .btn-view-detail:hover {
        background: #c9a063;
        border-color: #c9a063;
        color: white;
        transform: translateX(5px);
    }

    /* Success Toast */
    .toast-custom {
        position: fixed;
        top: 100px;
        right: 30px;
        background: white;
        padding: 20px 30px;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        z-index: 9999;
        display: none;
        align-items: center;
        gap: 15px;
        border-left: 4px solid #2ecc71;
    }

    .toast-custom.show {
        display: flex;
        animation: slideIn 0.3s ease;
    }

    .toast-icon {
        width: 40px;
        height: 40px;
        background: #2ecc71;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
    }

    .toast-content h5 {
        margin: 0 0 5px 0;
        font-weight: 600;
        color: #1a1a1a;
        font-size: 16px;
    }

    .toast-content p {
        margin: 0;
        color: #666;
        font-size: 14px;
    }

    @@keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Responsive */
    @@media (max-width: 991px) {
        .product-info-container {
            padding-left: 0;
            margin-top: 30px;
        }

        .product-title {
            font-size: 28px;
        }

        .price-current,
        .price-regular {
            font-size: 32px;
        }

        .main-image {
            height: 400px;
        }

        .action-buttons {
            flex-direction: column;
        }

        .btn-wishlist {
            width: 100%;
            border-radius: 50px;
        }
    }
</style>

<!-- Toast Notification -->
<div class="toast-custom" id="cartToast">
    <div class="toast-icon">
        <i class="fas fa-check"></i>
    </div>
    <div class="toast-content">
        <h5>Thêm vào giỏ hàng thành công!</h5>
        <p>Sản phẩm đã được thêm vào giỏ hàng của bạn</p>
    </div>
</div>

<section class="product-detail-section">
    <div class="container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb-custom">
            <a href="@Url.Action("Index", "Home")">Trang chủ</a>
            <span class="mx-2">/</span>
            <a href="@Url.Action("Index", "Product")">Sản phẩm</a>
            <span class="mx-2">/</span>
            @if (Model.Category != null)
            {
                <a href="@Url.Action("Index", "Product", new { category = Model.Category.CategoryName })">@Model.Category.CategoryName</a>
                <span class="mx-2">/</span>
            }
            <span class="active">@Model.ProductName</span>
        </nav>

        <div class="row">
            <!-- Product Gallery -->
            <div class="col-lg-6">
                <div class="product-gallery">
                    <div class="main-image-container">
                        <img src="@Model.ImageUrl" alt="@Model.ProductName" class="main-image" id="mainImage">
                        @if (Model.DiscountPrice.HasValue && Model.DiscountPrice > 0)
                        {
                            <div class="discount-badge">
                                -@Math.Round((decimal)(((Model.Price - Model.DiscountPrice) / Model.Price) * 100), 0)% OFF
                            </div>
                        }
                    </div>
                    <div class="thumbnail-gallery">
                        <div class="thumbnail-item active" onclick="changeImage('@Model.ImageUrl')">
                            <img src="@Model.ImageUrl" alt="@Model.ProductName">
                        </div>
                        @if (!string.IsNullOrEmpty(Model.Detail1))
                        {
                            <div class="thumbnail-item" onclick="changeImage('@Model.Detail1')">
                                <img src="@Model.Detail1" alt="@Model.ProductName">
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.Detail2))
                        {
                            <div class="thumbnail-item" onclick="changeImage('@Model.Detail2')">
                                <img src="@Model.Detail2" alt="@Model.ProductName">
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Product Info -->
            <div class="col-lg-6">
                <div class="product-info-container">
                    @if (Model.Category != null)
                    {
                        <span class="product-category">
                            <i class="fas fa-tag me-1"></i>
                            @Model.Category.CategoryName
                        </span>
                    }

                    <h1 class="product-title">@Model.ProductName</h1>

                    <div class="product-rating">
                        <span class="stars">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                        </span>
                        <span class="rating-text">(4.5/5 - 128 đánh giá)</span>
                    </div>

                    <div class="divider"></div>

                    <div class="price-container">
                        @if (Model.DiscountPrice.HasValue && Model.DiscountPrice > 0)
                        {
                            <span class="price-current">@Model.DiscountPrice.Value.ToString("N0")đ</span>
                            <span class="price-original">@Model.Price.ToString("N0")đ</span>
                            <span class="save-amount">
                                Tiết kiệm @((Model.Price - Model.DiscountPrice.Value).ToString("N0"))đ
                            </span>
                        }
                        else
                        {
                            <span class="price-regular">@Model.Price.ToString("N0")đ</span>
                        }
                    </div>

                    @{
                        var stockClass = Model.Stock > 10 ? "" : (Model.Stock > 0 ? "low-stock" : "out-of-stock");
                        var stockIcon = Model.Stock > 10 ? "fa-check-circle" : (Model.Stock > 0 ? "fa-exclamation-circle" : "fa-times-circle");
                        var stockText = Model.Stock > 10 ? $"Còn hàng ({Model.Stock} sản phẩm)" : (Model.Stock > 0 ? $"Sắp hết hàng (Chỉ còn {Model.Stock} sản phẩm)" : "Hết hàng");
                    }

                    <div class="stock-info @stockClass">
                        <i class="fas @stockIcon"></i>
                        <strong>@stockText</strong>
                    </div>

                    <p class="product-description">
                        @(Model.Description ?? "Sản phẩm thời trang cao cấp với chất liệu tốt, thiết kế tinh tế và hiện đại. Phù hợp cho nhiều dịp khác nhau, mang đến sự tự tin và phong cách cho người mặc.")
                    </p>

                    @{
                        var hasVariants = ViewBag.Variants != null && ((System.Collections.IEnumerable)ViewBag.Variants).Cast<object>().Any();
                        var hasSizes = ViewBag.Sizes != null && ((System.Collections.Generic.List<string>)ViewBag.Sizes).Any();
                        var hasColors = ViewBag.Colors != null && ((System.Collections.Generic.List<string>)ViewBag.Colors).Any();
                    }
                    
                    @if (hasVariants)
                    {
                        @* Size Selector *@
                        if (hasSizes)
                        {
                            <div class="variant-selector mb-4">
                                <label class="quantity-label">Kích cỡ:</label>
                                <div class="variant-options">
                                    @foreach (var size in ViewBag.Sizes)
                                    {
                                        <button type="button" class="variant-btn" data-variant-type="size" data-value="@size" onclick="selectVariant('size', '@size', this)">
                                            @size
                                        </button>
                                    }
                                </div>
                                <input type="hidden" id="selectedSize" value="" />
                            </div>
                        }

                        @* Color Selector *@
                        if (hasColors)
                        {
                            <div class="variant-selector mb-4">
                                <label class="quantity-label">Màu sắc:</label>
                                <div class="variant-options">
                                    @foreach (var color in ViewBag.Colors)
                                    {
                                        <button type="button" class="variant-btn color-btn" data-variant-type="color" data-value="@color" onclick="selectVariant('color', '@color', this)" style="background-color: @GetColorCode(color);">
                                            @color
                                        </button>
                                    }
                                </div>
                                <input type="hidden" id="selectedColor" value="" />
                            </div>
                        }

                        <input type="hidden" id="selectedVariantId" value="" />
                        <div id="variantInfo" class="mb-3" style="display: none;">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="variantStockInfo"></span>
                            </div>
                        </div>
                    }

                    @{
                        var availableStock = Model.Stock;
                        if (ViewBag.Variants != null && ((System.Collections.Generic.IEnumerable<dynamic>)ViewBag.Variants).Any())
                        {
                            // Stock sẽ được cập nhật động khi chọn variant
                        }
                    }

                    @if (Model.Stock > 0 || (ViewBag.Variants != null && ((System.Collections.Generic.IEnumerable<dynamic>)ViewBag.Variants).Any()))
                    {
                        <div class="quantity-selector">
                            <label class="quantity-label">Số lượng:</label>
                            <div class="quantity-controls">
                                <div class="quantity-input-group">
                                    <button class="quantity-btn" onclick="decreaseQuantity()">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" id="quantity" value="1" min="1" max="@availableStock" class="quantity-input" readonly>
                                    <button class="quantity-btn" onclick="increaseQuantity(@availableStock)">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn-add-cart" onclick="addToCart(@Model.Id)" id="addToCartBtn">
                                <i class="fas fa-shopping-cart"></i>
                                Thêm Vào Giỏ Hàng
                            </button>
                            <button class="btn-wishlist" title="Thêm vào yêu thích">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Sản phẩm hiện đã hết hàng. Vui lòng liên hệ shop để được tư vấn!
                        </div>
                    }

                    <div class="product-features">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="feature-text">
                                <div class="feature-title">Miễn phí vận chuyển</div>
                                <p class="feature-desc">Cho đơn hàng từ 500.000đ</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-undo-alt"></i>
                            </div>
                            <div class="feature-text">
                                <div class="feature-title">Đổi trả trong 7 ngày</div>
                                <p class="feature-desc">Nếu sản phẩm lỗi hoặc không vừa</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="feature-text">
                                <div class="feature-title">Đảm bảo chính hãng</div>
                                <p class="feature-desc">100% sản phẩm chính hãng</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Related Products -->
@if (ViewBag.RelatedProducts != null && ((System.Collections.Generic.List<FashionStore.Models.Entities.Product>)ViewBag.RelatedProducts).Any())
{
    <section class="related-section">
        <div class="container">
            <h2 class="section-title">Sản Phẩm Liên Quan</h2>
            <div class="section-divider"></div>

            <div class="row">
                @foreach (var product in ViewBag.RelatedProducts)
                {
                    <div class="col-lg-3 col-md-6">
                        <div class="related-product-card">
                            <div class="related-product-image">
                                <img src="@product.ImageUrl" alt="@product.ProductName">
                            </div>
                            <div class="related-product-info">
                                <h4 class="related-product-name">@product.ProductName</h4>
                                <div class="related-product-price">
                                    @if (product.DiscountPrice != null && product.DiscountPrice > 0)
                                    {
                                        <span class="related-price-original">@product.Price.ToString("N0") đ</span>
                                        <span class="related-price-discount">@product.DiscountPrice.ToString("N0") đ</span>
                                    }
                                    else
                                    {
                                        <span class="related-price-regular">@product.Price.ToString("N0") đ</span>
                                    }
                                </div>
                                <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="btn-view-detail">
                                    Xem Chi Tiết <i class="fas fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </section>
}

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Change main image
        function changeImage(imageUrl) {
            document.getElementById('mainImage').src = imageUrl;

            // Update active thumbnail
            document.querySelectorAll('.thumbnail-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
        }

        // Quantity controls
        function increaseQuantity(maxStock) {
            var input = document.getElementById('quantity');
            var currentValue = parseInt(input.value);
            if (currentValue < maxStock) {
                input.value = currentValue + 1;
            }
        }

        function decreaseQuantity() {
            var input = document.getElementById('quantity');
            var currentValue = parseInt(input.value);
            if (currentValue > 1) {
                input.value = currentValue - 1;
            }
        }

        // Variant data
        var variants = @Html.Raw(ViewBag.Variants != null ? System.Web.Helpers.Json.Encode(ViewBag.Variants) : "[]");
        var baseStock = @Model.Stock;

        // Select variant (size/color)
        function selectVariant(type, value, buttonElement) {
            try {
                // Update selected value
                if (type === 'size') {
                    document.getElementById('selectedSize').value = value;
                    // Remove selected class from all size buttons
                    document.querySelectorAll('[data-variant-type="size"]').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    // Add selected class to clicked button
                    if (buttonElement) {
                        buttonElement.classList.add('selected');
                    }
                } else if (type === 'color') {
                    document.getElementById('selectedColor').value = value;
                    // Remove selected class from all color buttons
                    document.querySelectorAll('[data-variant-type="color"]').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    // Add selected class to clicked button
                    if (buttonElement) {
                        buttonElement.classList.add('selected');
                    }
                }

                // Find matching variant
                updateVariantSelection();
            } catch (error) {
                console.error('Error selecting variant:', error);
            }
        }

        function updateVariantSelection() {
            var selectedSize = document.getElementById('selectedSize').value;
            var selectedColor = document.getElementById('selectedColor').value;
            var variantId = '';
            var variantStock = baseStock;
            var variantPrice = @Model.Price;

            // Find variant that matches selected size and color
            if (variants && variants.length > 0) {
                var matchingVariant = variants.find(function(v) {
                    var sizeMatch = !selectedSize || v.Size === selectedSize;
                    var colorMatch = !selectedColor || v.Color === selectedColor;
                    return sizeMatch && colorMatch && v.IsActive;
                });

                if (matchingVariant) {
                    variantId = matchingVariant.Id;
                    variantStock = matchingVariant.Stock || 0;
                    if (matchingVariant.Price) {
                        variantPrice = matchingVariant.Price;
                    }
                }
            }

            // Update hidden field
            document.getElementById('selectedVariantId').value = variantId;

            // Update stock info
            var variantInfoDiv = document.getElementById('variantInfo');
            var stockInfoSpan = document.getElementById('variantStockInfo');
            var quantityInput = document.getElementById('quantity');
            var maxStock = variantStock || baseStock;

            if (variantId) {
                variantInfoDiv.style.display = 'block';
                if (variantStock > 0) {
                    stockInfoSpan.innerHTML = 'Tồn kho: ' + variantStock + ' sản phẩm';
                    stockInfoSpan.parentElement.className = 'alert alert-info';
                } else {
                    stockInfoSpan.innerHTML = 'Biến thể này đã hết hàng';
                    stockInfoSpan.parentElement.className = 'alert alert-warning';
                }
            } else {
                variantInfoDiv.style.display = 'none';
            }

            // Update quantity max
            quantityInput.max = maxStock;
            if (parseInt(quantityInput.value) > maxStock) {
                quantityInput.value = maxStock;
            }

            // Update price if variant has different price
            if (variantId && variantPrice !== @Model.Price) {
                // You can update price display here if needed
            }
        }

        // Add to cart
        function addToCart(productId) {
            try {
                var quantityInput = document.getElementById('quantity');
                var quantity = parseInt(quantityInput.value) || 1;
                var variantIdInput = document.getElementById('selectedVariantId');
                var variantId = variantIdInput ? variantIdInput.value : '';
                var selectedSizeInput = document.getElementById('selectedSize');
                var selectedSize = selectedSizeInput ? selectedSizeInput.value : '';
                var selectedColorInput = document.getElementById('selectedColor');
                var selectedColor = selectedColorInput ? selectedColorInput.value : '';

                // Validate quantity
                if (isNaN(quantity) || quantity < 1) {
                    alert('Số lượng không hợp lệ');
                    return;
                }

                // Check if variants are required but not selected
                if (variants && variants.length > 0) {
                    var hasSizes = @((ViewBag.Sizes != null && ((System.Collections.Generic.List<string>)ViewBag.Sizes).Any()) ? "true" : "false");
                    var hasColors = @((ViewBag.Colors != null && ((System.Collections.Generic.List<string>)ViewBag.Colors).Any()) ? "true" : "false");
                    
                    if (hasSizes && !selectedSize) {
                        alert('Vui lòng chọn kích cỡ');
                        return;
                    }
                    if (hasColors && !selectedColor) {
                        alert('Vui lòng chọn màu sắc');
                        return;
                    }

                    // Check if variant is selected when variants exist
                    if (!variantId) {
                        alert('Vui lòng chọn đầy đủ thông tin sản phẩm (kích cỡ và màu sắc)');
                        return;
                    }
                }

                // Disable button during request
                var addToCartBtn = document.getElementById('addToCartBtn');
                if (addToCartBtn) {
                    addToCartBtn.disabled = true;
                    addToCartBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang thêm...';
                }

                $.ajax({
                    url: '/Cart/AddToCart',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        productId: productId,
                        quantity: quantity,
                        productVariantId: variantId || null
                    },
                    success: function (response) {
                        if (response.success) {
                            // Show toast notification
                            var toast = document.getElementById('cartToast');
                            if (toast) {
                                toast.classList.add('show');
                                // Hide toast after 3 seconds
                                setTimeout(function () {
                                    toast.classList.remove('show');
                                }, 3000);
                            }

                            // Update cart badge if exists
                            if (typeof updateCartBadge === 'function' && response.cartCount) {
                                updateCartBadge(response.cartCount);
                            } else if (response.cartCount) {
                                // Try to update cart count in header if exists
                                var cartCountElement = document.querySelector('.cart-count, #cartCount');
                                if (cartCountElement) {
                                    cartCountElement.textContent = response.cartCount;
                                }
                            }
                        } else {
                            alert(response.message || 'Có lỗi xảy ra khi thêm vào giỏ hàng');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('AJAX Error:', error);
                        var errorMessage = 'Có lỗi xảy ra khi thêm vào giỏ hàng';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        alert(errorMessage);
                    },
                    complete: function () {
                        // Re-enable button
                        if (addToCartBtn) {
                            addToCartBtn.disabled = false;
                            addToCartBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Thêm Vào Giỏ Hàng';
                        }
                    }
                });
            } catch (error) {
                console.error('Error adding to cart:', error);
                alert('Có lỗi xảy ra. Vui lòng thử lại.');
            }
        }
        }

        // Wishlist button
        document.querySelector('.btn-wishlist').addEventListener('click', function () {
            this.querySelector('i').classList.toggle('far');
            this.querySelector('i').classList.toggle('fas');

            if (this.querySelector('i').classList.contains('fas')) {
                this.style.background = '#e74c3c';
                this.style.color = 'white';
                this.style.borderColor = '#e74c3c';
            } else {
                this.style.background = 'white';
                this.style.color = '#1a1a1a';
                this.style.borderColor = '#e5e5e5';
            }
        });
    </script>
}